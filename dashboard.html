<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MicroVest</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <div class="app-shell">
        <div class="top-nav">
            <div class="profile-info">
                <div class="user-avatar" id="userInitial">U</div>
                <div>
                    <span style="display: block; font-size: 12px; color: var(--text-muted); font-weight: 400;">Selamat Kembali,</span>
                    <span id="displayEmail" style="font-size: 14px;">Memuatkan...</span>
                </div>
            </div>
            <button class="btn-logout" onclick="handleLogout()" title="Log Keluar">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>

        <div class="main-card">
            <p><i class="fas fa-wallet"></i> Jumlah Baki Anda</p>
            <h2 id="userBalance">RM 0.00</h2>
            <div style="margin-top: 15px; font-size: 12px; background: rgba(255,255,255,0.2); display: inline-block; padding: 5px 12px; border-radius: 20px;">
                Status: Pelabur Aktif
            </div>
        </div>

        <div class="quick-actions">
            <div class="action-item" onclick="location.href='recharge.html'">
                <div class="icon-box"><i class="fas fa-plus-circle"></i></div>
                <span>Deposit</span>
            </div>
            <div class="action-item" onclick="location.href='withdraw.html'">
                <div class="icon-box"><i class="fas fa-hand-holding-usd"></i></div>
                <span>Keluarkan</span>
            </div>
            <div class="action-item" onclick="location.href='team.html'">
                <div class="icon-box"><i class="fas fa-users"></i></div>
                <span>Pasukan</span>
            </div>
        </div>

        */

        <div class="investment-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0; font-size: 16px;">Pelaburan Aktif</h3>
        <span style="font-size: 11px; color: var(--primary); font-weight: bold;">Status: Berjalan</span>
    </div>

    <div id="activeInvestmentsList">
        <p style="text-align: center; color: var(--text-muted); font-size: 12px; padding: 20px;">
            Tiada pelaburan aktif buat masa ini.
        </p>
    </div>
</div>


        <nav class="bottom-nav">
            <a href="dashboard.html" class="nav-item active">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="product_list.html" class="nav-item">
                <i class="fas fa-chart-line"></i>
                <span>Produk</span>
            </a>
            <a href="profile.html" class="nav-item">
                <i class="fas fa-user-circle"></i>
                <span>Profil</span>
            </a>
        </nav>
    </div>

    <script src="app.js"></script>
    <script>
    async function loadDashboardData() {
        // 1. Semak jika pengguna log masuk
        const { data: { user } } = await client.auth.getUser();

        if (!user) {
            window.location.href = 'login.html';
            return;
        }

        // 2. Papar emel dan initial
        document.getElementById('displayEmail').innerText = user.email;
        document.getElementById('userInitial').innerText = user.email.charAt(0).toUpperCase();

        // 3. Ambil baki dari table 'profiles'
        const { data, error } = await client
            .from('profiles')
            .select('balance')
            .eq('id', user.id)
            .single();

        if (data) {
            document.getElementById('userBalance').innerText = `RM ${data.balance.toFixed(2)}`;
        }

        // --- TAMBAHKAN BARIS INI ---
        // Panggil fungsi pelaburan aktif menggunakan ID pengguna
        loadActiveInvestments(user.id);
        // ---------------------------
    }

    // --- LETAKKAN FUNGSI BARU ANDA DI SINI ---
    async function loadActiveInvestments(userId) {
        const listContainer = document.getElementById('activeInvestmentsList');

        const { data, error } = await client
            .from('user_investments')
            .select('*')
            .eq('user_id', userId)
            .eq('status', 'active');

        if (data && data.length > 0) {
            listContainer.innerHTML = ''; 
            
            data.forEach(item => {
                const startDate = new Date(item.created_at);
                const today = new Date();
                const diffTime = Math.abs(today - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const progressPercent = (diffDays / 365) * 100;

                listContainer.innerHTML += `
                    <div class="active-plan-card" style="background: #fdf2f2; border-radius: 12px; padding: 15px; margin-bottom: 12px; border-left: 5px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="font-weight: 800; font-size: 14px; color: var(--primary);">${item.plan_name}</span>
                            <span style="font-size: 11px; color: var(--success); font-weight: bold;">+ RM ${item.daily_profit.toFixed(2)}/hari</span>
                        </div>
                        <div class="progress-container" style="height: 6px; background: #eee; border-radius: 10px; margin-bottom: 5px;">
                            <div class="progress-bar" style="width: ${progressPercent}%; height: 100%; background: var(--primary); border-radius: 10px;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted);">
                            <span>Hari ke-${diffDays}</span>
                            <span>Tamat: 365 hari</span>
                        </div>
                    </div>
                `;
            });
        }
    }

    window.onload = loadDashboardData;
</script>

</body>
</html>



