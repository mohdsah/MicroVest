<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deposit - MicroVest</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <div class="app-shell">
        <div class="product-page-header">
            <button onclick="history.back()" style="position: absolute; left: 20px; top: 40px; background: none; border: none; color: white; font-size: 20px;">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2>Tambah Nilai</h2>
            <p>Sila buat bayaran ke akaun di bawah</p>
        </div>

        <div class="content-area" style="padding: 20px; margin-top: -30px;">
            <div class="recharge-card">
                <div class="bank-details">
                    <p>Nama Bank:</p>
                    <b>MAYBANK (MBB)</b>
                    <p style="margin-top:10px;">No. Akaun:</p>
                    <b id="accNo">123456789012</b> 
                    <button onclick="copyAcc()" style="font-size:10px; padding:2px 5px; margin-left:10px;">Salin</button>
                    <p style="margin-top:10px;">Nama Penerima:</p>
                    <b>MICROVEST GLOBAL SERVICES</b>
                </div>

                <div class="input-group">
                    <label>Jumlah Deposit (RM)</label>
                    <input type="number" id="amount" class="auth-input" placeholder="Min: RM 30.00">
                </div>

                <div class="input-group">
                    <label>Muat Naik Resit (Gambar)</label>
                    <div class="upload-area" onclick="document.getElementById('receipt').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p id="uploadText" style="font-size: 12px; color: #64748b;">Klik untuk pilih gambar resit</p>
                        <img id="imagePreview" src="" alt="Preview">
                    </div>
                    <input type="file" id="receipt" hidden accept="image/*" onchange="previewImage(this)">
                </div>

                <button onclick="submitRecharge()" id="btnSubmit" class="btn-auth" style="margin-top: 20px;">HANTAR REKOD</button>
            </div>
        </div>
    </div>

      <script src="app.js"></script>
    <script>
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            const text = document.getElementById('uploadText');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    text.style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function submitRecharge() {
            const amount = document.getElementById('amount').value;
            const file = document.getElementById('receipt').files[0];
            const btn = document.getElementById('btnSubmit');

            if (!amount || amount < 30) return alert("Minimum deposit adalah RM 30");
            if (!file) return alert("Sila muat naik resit pembayaran");

            btn.innerText = "MEMPROSES...";
            btn.disabled = true;

            try {
                const { data: { user } } = await client.auth.getUser();
                if (!user) throw new Error("Sesi tamat. Sila login semula.");

                // 1. Muat naik gambar ke Storage Supabase
                // Pastikan anda sudah create bucket bernama 'receipts' di Supabase
                const fileName = `public/${user.id}-${Date.now()}.png`;
                const { data: uploadData, error: uploadError } = await client.storage
                    .from('receipts')
                    .upload(fileName, file);

                if (uploadError) throw uploadError;

                // 2. Simpan rekod ke table 'recharges'
                const { error: dbError } = await client.from('recharges').insert([{
                    user_id: user.id,
                    amount: parseFloat(amount),
                    proof_img: fileName,
                    status: 'pending'
                }]);

                if (dbError) throw dbError;

                // 3. NOTIFIKASI TELEGRAM (Sangat Penting!)
                const msg = `ðŸ’° <b>DEPOSIT BARU!</b>\n\n` +
                            `ðŸ‘¤ User: ${user.email}\n` +
                            `ðŸ’µ Jumlah: <b>RM ${parseFloat(amount).toFixed(2)}</b>\n` +
                            `ðŸ•’ Masa: ${new Date().toLocaleString('ms-MY')}\n\n` +
                            `Sila semak dashboard untuk pengesahan.`;
                
                await sendTelegramAlert(msg);

                alert("Deposit berjaya dihantar! Admin akan mengesahkan dalam masa 1-30 minit.");
                window.location.href = 'records.html';

            } catch (error) {
                console.error(error);
                alert("Ralat: " + (error.message || "Gagal menghantar rekod"));
                btn.innerText = "HANTAR REKOD";
                btn.disabled = false;
            }
        }

        function copyAcc() {
            const acc = document.getElementById('accNo').innerText;
            navigator.clipboard.writeText(acc);
            alert("No. Akaun disalin!");
        }
    </script>
</body>
</html>
