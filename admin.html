<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - MicroVest</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="background: #f1f5f9;">

    <div class="app-shell">
        <div class="product-page-header">
            <h2>Pusat Kawalan Admin</h2>
            <p>Urus Deposit & Withdraw</p>
        </div>

        <div class="content-area" style="padding: 20px; margin-top: -20px;">
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <div class="recharge-card" style="flex: 1; text-align: center; padding: 15px;">
                    <small style="color: #64748b;">PENDING DEPOSIT</small>
                    <h2 id="countPending" style="color: #f59e0b;">0</h2>
                </div>
                <div class="recharge-card" style="flex: 1; text-align: center; padding: 15px;">
                    <small style="color: #64748b;">PENDING WITHDRAW</small>
                    <h2 id="countWithdraw" style="color: #ef4444;">0</h2>
                </div>
            </div>

            <div class="recharge-card">
                <h4 style="margin-bottom: 15px; color: #1e293b; border-left: 4px solid #10b981; padding-left: 10px;">
                    Deposit Perlu Disahkan
                </h4>
                <div id="depositList">
                    <p style="text-align: center; color: #94a3b8;">Memuatkan deposit...</p>
                </div>
            </div>

            <div class="recharge-card" style="margin-top: 20px;">
                <h4 style="margin-bottom: 15px; color: #1e293b; border-left: 4px solid #ef4444; padding-left: 10px;">
                    Permohonan Withdraw
                </h4>
                <div id="withdrawList">
                    <p style="text-align: center; color: #94a3b8;">Memuatkan permohonan...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. KONFIGURASI SUPABASE (Pastikan URL & Key betul)
        const SUPABASE_URL = 'https://mgvjwgbjccgsjkjhddru.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ndmp3Z2JqY2Nnc2pramhkZHJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMzQxNzcsImV4cCI6MjA4NTYxMDE3N30.JJ03f7HO4bKiCF2g0eY3HzrT2KHKUzjpYgBALYHeYa0'; 
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. FUNGSI LOAD DEPOSIT
        async function loadPendingDeposits() {
            try {
                const { data, error } = await client
                    .from('recharges')
                    .select('*, profiles(email)')
                    .eq('status', 'pending');

                if (error) throw error;
                const container = document.getElementById('depositList');
                document.getElementById('countPending').innerText = data.length;

                if (data.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #94a3b8; font-size: 13px;">Tiada deposit pending.</p>';
                    return;
                }

                container.innerHTML = data.map(item => `
                    <div style="padding: 15px; border-bottom: 1px solid #eee; margin-bottom: 10px; background: #f0fdf4; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <b style="font-size: 13px;">${item.profiles?.email}</b><br>
                                <b style="color: #10b981;">RM ${parseFloat(item.amount).toFixed(2)}</b>
                            </div>
                            <button onclick="approveDeposit('${item.id}', '${item.user_id}', ${item.amount})" 
                                    style="background: #10b981; color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 11px;">
                                APPROVE
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (err) { console.error(err); }
        }

        // 3. FUNGSI APPROVE DEPOSIT
        async function approveDeposit(depositId, userId, amount) {
            if (!confirm(`Luluskan deposit RM ${amount}?`)) return;
            try {
                // Update status deposit
                await client.from('recharges').update({ status: 'success' }).eq('id', depositId);
                
                // Tambah baki user
                const { data: profile } = await client.from('profiles').select('balance').eq('id', userId).single();
                const newBal = (profile.balance || 0) + parseFloat(amount);
                await client.from('profiles').update({ balance: newBal }).eq('id', userId);

                alert("Deposit Berjaya!");
                loadPendingDeposits(); // Data akan hilang dari senarai automatik
            } catch (err) { alert(err.message); }
        }

        // 4. FUNGSI LOAD WITHDRAWALS
        async function loadPendingWithdrawals() {
            try {
                const { data, error } = await client
                    .from('withdrawals')
                    .select('*, profiles(email)')
                    .eq('status', 'pending');

                if (error) throw error;
                const container = document.getElementById('withdrawList');
                document.getElementById('countWithdraw').innerText = data.length;

                if (data.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #94a3b8; font-size: 13px;">Tiada withdraw pending.</p>';
                    return;
                }

                container.innerHTML = data.map(item => `
                    <div style="padding: 15px; border-bottom: 1px solid #eee; margin-bottom: 10px; background: #fff1f2; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <b style="font-size: 13px;">${item.profiles?.email}</b><br>
                                <b style="color: #ef4444;">RM ${parseFloat(item.amount).toFixed(2)}</b><br>
                                <small>${item.bank_name}: ${item.bank_account}</small>
                            </div>
                            <button onclick="approveWithdraw('${item.id}')" 
                                    style="background: #ef4444; color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 11px;">
                                DONE PAY
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (err) { console.error(err); }
        }

        // 5. FUNGSI APPROVE WITHDRAW
        async function approveWithdraw(id) {
            if(!confirm("Anda sudah transfer duit ke bank user?")) return;
            try {
                await client.from('withdrawals').update({ status: 'success' }).eq('id', id);
                alert("Withdraw Selesai!");
                loadPendingWithdrawals(); // Data akan hilang dari senarai automatik
            } catch (err) { alert(err.message); }
        }

        // Jalankan semasa mula
        document.addEventListener('DOMContentLoaded', () => {
            loadPendingDeposits();
            loadPendingWithdrawals();
        });
    </script>
</body>
</html>
