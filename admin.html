<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - MicroVest</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="background: #f1f5f9;">

    <div class="app-shell">
        <div class="product-page-header">
            <h2>Pusat Kawalan Admin</h2>
            <p>Urus Deposit & Baki Pengguna</p>
        </div>

        <div class="content-area" style="padding: 20px; margin-top: -20px;">
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <div class="recharge-card" style="flex: 1; text-align: center; padding: 15px;">
                    <small style="color: #64748b;">PENDING DEPOSIT</small>
                    <h2 id="countPending" style="color: #f59e0b;">0</h2>
                </div>
            </div>

            <div class="recharge-card">
                <h4 style="margin-bottom: 15px; color: #1e293b; border-left: 4px solid #10b981; padding-left: 10px;">
                    Deposit Perlu Disahkan
                </h4>
                <div id="depositList">
                    <p style="text-align: center; color: #94a3b8; font-size: 13px;">Memuatkan data...</p>
                </div>
            </div>

            <div class="recharge-card" style="margin-top: 20px;">
                <h4 style="margin-bottom: 15px; color: #1e293b;">Urus Baki Pengguna</h4>
                <div class="input-group">
                    <input type="email" id="manualEmail" class="auth-input" placeholder="Emel User...">
                </div>
                <div class="input-group">
                    <input type="number" id="manualAmount" class="auth-input" placeholder="Jumlah (Cth: 100 atau -100)">
                </div>
                <button onclick="manualUpdate()" class="btn-auth" style="background: #1e293b;">UPDATE BAKI</button>
            </div>
        </div>
    </div>

    <script>
        // 1. KONFIGURASI SUPABASE
        const SUPABASE_URL = 'https://mgvjwgbjccgsjkjhddru.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // TAMPAL KEY PENUH ANDA DI SINI
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. FUNGSI LOAD DEPOSIT PENDING
        async function loadPendingDeposits() {
            try {
                const { data, error } = await client
                    .from('recharges')
                    .select('*, profiles(email, full_name)')
                    .eq('status', 'pending');

                if (error) throw error;

                const container = document.getElementById('depositList');
                document.getElementById('countPending').innerText = data.length;

                if (data.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #94a3b8;">Tiada deposit pending.</p>';
                    return;
                }

                container.innerHTML = data.map(item => `
                    <div style="padding: 15px; border-bottom: 1px solid #eee; margin-bottom: 10px; background: #fafafa; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <b style="font-size: 14px;">${item.profiles?.email || 'User'}</b><br>
                                <span style="color: #10b981; font-weight: bold;">RM ${item.amount.toFixed(2)}</span>
                            </div>
                            <button onclick="approveDeposit('${item.id}', '${item.user_id}', ${item.amount})" 
                                    style="background: #10b981; color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                APPROVE
                            </button>
                        </div>
                        <div style="margin-top: 10px;">
                            <a href="${SUPABASE_URL}/storage/v1/object/public/receipts/${item.proof_img}" target="_blank" style="font-size: 11px; color: #3b82f6;">
                                <i class="fas fa-image"></i> Lihat Resit
                            </a>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error(err);
            }
        }

        // 3. FUNGSI APPROVE (UPDATE STATUS & TAMBAH BAKI)
        async function approveDeposit(depositId, userId, amount) {
            if (!confirm(`Approve deposit RM ${amount}?`)) return;

            try {
                // A. Kemaskini status deposit
                const { error: updateError } = await client
                    .from('recharges')
                    .update({ status: 'success' })
                    .eq('id', depositId);

                if (updateError) throw updateError;

                // B. Ambil baki semasa pengguna
                const { data: profile, error: profileError } = await client
                    .from('profiles')
                    .select('balance')
                    .eq('id', userId)
                    .single();

                if (profileError) throw profileError;

                // C. Kira baki baru dan simpan
                const newBalance = (profile.balance || 0) + parseFloat(amount);
                const { error: balanceError } = await client
                    .from('profiles')
                    .update({ balance: newBalance })
                    .eq('id', userId);

                if (balanceError) throw balanceError;

                alert("Berjaya! Status dikemaskini dan baki ditambah.");
                loadPendingDeposits();

            } catch (err) {
                alert("Ralat: " + err.message);
            }
        }

        // 4. UPDATE BAKI MANUAL
        async function manualUpdate() {
            const email = document.getElementById('manualEmail').value;
            const amount = document.getElementById('manualAmount').value;
            if (!email || !amount) return alert("Sila isi emel dan jumlah");

            try {
                const { data: profile } = await client.from('profiles').select('id, balance').eq('email', email).single();
                if (!profile) return alert("User tidak dijumpai");

                const newBal = (profile.balance || 0) + parseFloat(amount);
                await client.from('profiles').update({ balance: newBal }).eq('id', profile.id);

                alert("Baki berjaya dikemaskini!");
                location.reload();
            } catch (err) {
                alert("Ralat: " + err.message);
            }
        }

        document.addEventListener('DOMContentLoaded', loadPendingDeposits);
    </script>
</body>
</html>
