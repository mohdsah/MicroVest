<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroVest Elite Admin</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --admin-red: #800000; --dark-bg: #0f172a; --glass: rgba(255, 255, 255, 0.95); }
        body { background: #f1f5f9; font-family: 'Poppins', sans-serif; margin: 0; color: #1e293b; }
        
        /* Layout */
        .sidebar-nav { background: var(--dark-bg); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--admin-red); }
        .main-content { padding: 20px; max-width: 1200px; margin: auto; }
        
        /* Dashboard Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-top: 4px solid var(--admin-red); }
        .stat-card h3 { font-size: 24px; margin: 5px 0; color: var(--dark-bg); }
        .stat-card small { text-transform: uppercase; color: #64748b; font-size: 11px; letter-spacing: 1px; }

        /* Tables & Lists */
        .data-section { background: white; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.3s; font-size: 12px; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-green { background: #10b981; color: white; }
        .btn-red { background: #ef4444; color: white; }

        /* Pop-up Modal */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div id="loadingOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:10000; display:flex; align-items:center; justify-content:center;">
    <h3>Sila Tunggu...</h3>
</div>

<div id="adminPanel" style="display:none;">
    <div class="sidebar-nav">
        <div><i class="fas fa-user-shield"></i> MICROVEST HQ</div>
        <div id="adminMail" style="font-size:12px; opacity:0.8;"></div>
        <button onclick="logout()" class="btn btn-red">KELUAR</button>
    </div>

    <div class="main-content">
        <div class="stats-grid">
            <div class="stat-card"><small>Baki Keseluruhan</small><h3 id="statProfit">RM 0</h3></div>
            <div class="stat-card"><small>Ahli Berdaftar</small><h3 id="statUsers">0</h3></div>
            <div class="stat-card"><small>Depo Pending</small><h3 id="statDepo" style="color:#f59e0b">0</h3></div>
            <div class="stat-card"><small>Wd Pending</small><h3 id="statWd" style="color:#ef4444">0</h3></div>
        </div>

        <div class="data-section">
            <h4><i class="fas fa-wallet" style="color:var(--admin-red)"></i> Kelulusan Deposit</h4>
            <div id="listRecharge">Memuatkan...</div>
        </div>

        <div class="data-section">
            <h4><i class="fas fa-users"></i> Urus Pelabur</h4>
            <div id="listUsers">Memuatkan...</div>
        </div>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Edit User</h3>
        <input type="hidden" id="editUserId">
        <div id="modalBody">
            <label>Baki Baru (RM):</label>
            <input type="number" id="editVal" style="width:100%; padding:10px; margin:10px 0; border-radius:8px; border:1px solid #ddd;">
            <label>Role:</label>
            <select id="editRole" style="width:100%; padding:10px; margin:10px 0; border-radius:8px; border:1px solid #ddd;">
                <option value="user">User</option>
                <option value="admin">Admin</option>
            </select>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="closeModal()" class="btn" style="flex:1; background:#ccc;">BATAL</button>
            <button onclick="saveChanges()" class="btn btn-green" style="flex:1;">SIMPAN PERUBAHAN</button>
        </div>
    </div>
</div>

<script>
    // MASUKKAN API KEY ANDA DI SINI
    const SUPABASE_URL = 'https://mgvjwgbjccgsjkjhddru.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; 
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function checkSecurity() {
        const { data: { user } } = await client.auth.getUser();
        if (!user) { window.location.href = 'login.html'; return; }

        const { data: profile, error } = await client.from('profiles').select('*').eq('id', user.id).single();
        
        if (error || profile.role !== 'admin') {
            alert("Akses Ditolak! Anda bukan Admin.");
            window.location.href = 'dashboard.html';
        } else {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('adminMail').innerText = user.email;
            loadStats();
        }
    }

    async function loadStats() {
        const { data: users } = await client.from('profiles').select('*');
        const { data: depo } = await client.from('recharges').select('*').eq('status', 'pending');
        const { data: wd } = await client.from('withdrawals').select('*').eq('status', 'pending');

        const totalBal = users.reduce((a, b) => a + (b.balance || 0), 0);
        document.getElementById('statProfit').innerText = `RM ${totalBal.toFixed(2)}`;
        document.getElementById('statUsers').innerText = users.length;
        document.getElementById('statDepo').innerText = depo ? depo.length : 0;
        document.getElementById('statWd').innerText = wd ? wd.length : 0;

        renderUserList(users);
        renderDepoList(depo);
    }

    function renderUserList(users) {
        let html = '';
        users.forEach(u => {
            html += `
            <div class="item-row">
                <div><b>${u.email}</b><br><small>Baki: RM ${u.balance || 0} | Role: ${u.role}</small></div>
                <button onclick="openEdit('${u.id}', ${u.balance}, '${u.role}')" class="btn btn-blue">EDIT</button>
            </div>`;
        });
        document.getElementById('listUsers').innerHTML = html;
    }

    function renderDepoList(depo) {
        if (!depo || depo.length === 0) { document.getElementById('listRecharge').innerHTML = 'Tiada permohonan.'; return; }
        let html = '';
        depo.forEach(d => {
            html += `
            <div class="item-row">
                <div>RM ${d.amount}<br><small>ID: ${d.user_id}</small></div>
                <button onclick="approveDepo('${d.id}', '${d.user_id}', ${d.amount})" class="btn btn-green">LULUS</button>
            </div>`;
        });
        document.getElementById('listRecharge').innerHTML = html;
    }

    // Modal Logic
    function openEdit(id, bal, role) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editVal').value = bal;
        document.getElementById('editRole').value = role;
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('editModal').style.display = 'none'; }

    async function saveChanges() {
        const id = document.getElementById('editUserId').value;
        const newBal = document.getElementById('editVal').value;
        const newRole = document.getElementById('editRole').value;

        const { error } = await client.from('profiles').update({ balance: parseFloat(newBal), role: newRole }).eq('id', id);
        if (error) alert(error.message);
        else { alert("Data dikemaskini!"); closeModal(); loadStats(); }
    }

    async function approveDepo(id, uid, amt) {
        if (!confirm("Luluskan deposit ini?")) return;
        const { data: p } = await client.from('profiles').select('balance').eq('id', uid).single();
        await client.from('profiles').update({ balance: (p.balance || 0) + amt }).eq('id', uid);
        await client.from('recharges').update({ status: 'success' }).eq('id', id);
        alert("Berjaya!"); loadStats();
    }

    async function logout() { await client.auth.signOut(); window.location.href = 'login.html'; }

    document.addEventListener('DOMContentLoaded', checkSecurity);
</script>
</body>
</html>
