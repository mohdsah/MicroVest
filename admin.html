<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Elite Panel - MicroVest</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #800000; --secondary: #0f172a; --accent: #fbbf24; }
        body { background: #f8fafc; font-family: 'Inter', sans-serif; margin: 0; }
        #adminDashboard { display: none; padding: 20px; }
        .header-pro { background: var(--secondary); color: white; padding: 25px; border-radius: 20px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card-stat { background: white; padding: 20px; border-radius: 18px; border-left: 5px solid var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .card-stat h3 { margin: 10px 0 0 0; font-size: 22px; }
        .card-stat small { color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 10px; }
        .chart-container { background: white; padding: 20px; border-radius: 20px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .list-container { background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f1f5f9; transition: 0.2s; }
        .item-row:hover { background: #fdfdfd; }
        .btn-status { padding: 8px 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 11px; margin-left: 5px; }
        .log-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div id="adminDashboard">
        <div class="header-pro">
            <div>
                <h2 style="margin:0;">MicroVest HQ</h2>
                <small id="currentAdminEmail" style="color:var(--accent)"></small>
            </div>
            <button onclick="handleAdminLogout()" class="btn-status" style="background:#ef4444; color:white;">LOGOUT</button>
        </div>

        <div class="grid-stats">
            <div class="card-stat"><small>Untung Bersih</small><h3 id="netProfit" style="color:var(--primary)">RM 0</h3></div>
            <div class="card-stat" style="border-color:#10b981"><small>Total User</small><h3 id="totalUsersCount">0</h3></div>
            <div class="card-stat" style="border-color:#3b82f6"><small>Depo Sukses</small><h3 id="totalDepDone">RM 0</h3></div>
            <div class="card-stat" style="border-color:#f59e0b"><small>Pending Task</small><h3 id="totalPending">0</h3></div>
        </div>

        <div class="chart-container">
            <h4 style="margin-top:0;"><i class="fas fa-chart-line"></i> Aliran Tunai (Deposit vs Withdraw)</h4>
            <canvas id="financeChart" height="100"></canvas>
        </div>

        <div class="list-container">
            <h4><i class="fas fa-history"></i> Aktiviti Terkini (Log)</h4>
            <div id="recentLogs">Memuatkan rekod...</div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="list-container">
                <h4><i class="fas fa-arrow-down" style="color:#10b981"></i> Deposit Pending</h4>
                <div id="depositList"></div>
            </div>
            <div class="list-container">
                <h4><i class="fas fa-arrow-up" style="color:#ef4444"></i> Withdraw Pending</h4>
                <div id="withdrawList"></div>
            </div>
        </div>

        <div class="list-container" style="margin-top:20px;">
            <h4><i class="fas fa-user-friends"></i> Pengurusan Pengguna</h4>
            <div id="userList"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://mwnowiracticxrlfsrin.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13bm93aXJhY3RpY3hybGZzcmluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwOTI2NjYsImV4cCI6MjA4NTY2ODY2Nn0.aexL0u0a0OEM3CwakwW6dphsCReukhiikvZCSAYoFr4'; 
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let financeChart;

        async function checkAdminAccess() {
    // 1. Ambil sesi user yang sedang aktif
    const { data: { session } } = await client.auth.getSession();
    
    if (!session) { 
        window.location.href = 'login.html'; 
        return; 
    }

    // 2. Ambil data role terus dari database (bukan dari cache)
    const { data: profile, error } = await client
        .from('profiles')
        .select('role')
        .eq('id', session.user.id)
        .maybeSingle();

    if (error) {
        console.error("Ralat database:", error.message);
        alert("Ralat teknikal berlaku.");
        return;
    }

    // 3. Semak jika role benar-benar 'admin'
    if (profile && profile.role === 'admin') {
        document.getElementById('adminDashboard').style.display = 'block';
        document.getElementById('currentAdminEmail').innerText = session.user.email;
        renderAllData();
    } else {
        alert("Akses Ditolak! Role anda: " + (profile ? profile.role : 'Tiada'));
        window.location.href = 'dashboard.html';
    }
}


        async function handleAdminLogout() { await client.auth.signOut(); window.location.href = 'login.html'; }

        async function renderAllData() {
            const { count: uCount } = await client.from('profiles').select('id', { count: 'exact', head: true });
            const { data: dep } = await client.from('recharges').select('*');
            const { data: wit } = await client.from('withdrawals').select('*');
            
            const totalDep = dep.filter(x => x.status === 'success').reduce((a,b) => a + parseFloat(b.amount), 0);
            const totalWit = wit.filter(x => x.status === 'success').reduce((a,b) => a + parseFloat(b.amount), 0);
            const pendingCount = dep.filter(x => x.status === 'pending').length + wit.filter(x => x.status === 'pending').length;

            document.getElementById('totalUsersCount').innerText = uCount;
            document.getElementById('totalDepDone').innerText = `RM ${totalDep.toFixed(2)}`;
            document.getElementById('netProfit').innerText = `RM ${(totalDep - totalWit).toFixed(2)}`;
            document.getElementById('totalPending').innerText = pendingCount;

            updateChart(totalDep, totalWit);
            loadLists();
            loadLogs();
        }

        function updateChart(dep, wit) {
            const ctx = document.getElementById('financeChart').getContext('2d');
            if(financeChart) financeChart.destroy();
            financeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Deposit', 'Withdraw'],
                    datasets: [{ data: [dep, wit], backgroundColor: ['#10b981', '#ef4444'], borderRadius: 10 }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        async function loadLogs() {
            const { data: logs } = await client.from('transactions').select('*, profiles(email)').order('created_at', {ascending: false}).limit(10);
            document.getElementById('recentLogs').innerHTML = logs.map(l => `
                <div class="log-item">
                    <span><b>${l.profiles?.email}</b>: ${l.description}</span>
                    <b style="color:${l.type === 'withdraw' ? '#ef4444' : '#10b981'}">
                        ${l.type === 'withdraw' ? '-' : '+'} RM ${l.amount.toFixed(2)}
                    </b>
                </div>
            `).join('') || 'Tiada rekod terkini.';
        }

        async function loadLists() {
            const { data: dList } = await client.from('recharges').select('*, profiles(email)').eq('status', 'pending');
            document.getElementById('depositList').innerHTML = dList.map(i => `
                <div class="item-row">
                    <span>${i.profiles?.email}<br><b>RM ${i.amount}</b></span>
                    <button class="btn-status" style="background:#10b981; color:white" onclick="approveDep('${i.id}','${i.user_id}',${i.amount})">APPROVE</button>
                </div>
            `).join('') || '<small>Tiada pending</small>';

            const { data: wList } = await client.from('withdrawals').select('*, profiles(email)').eq('status', 'pending');
            document.getElementById('withdrawList').innerHTML = wList.map(i => `
                <div class="item-row">
                    <span>${i.profiles?.email}<br><b>RM ${i.amount}</b></span>
                    <button class="btn-status" style="background:#ef4444; color:white" onclick="approveWit('${i.id}','${i.user_id}',${i.amount})">PAID</button>
                </div>
            `).join('') || '<small>Tiada pending</small>';

            const { data: uList } = await client.from('profiles').select('*').order('created_at', {ascending: false});
            document.getElementById('userList').innerHTML = uList.map(u => `
                <div class="item-row">
                    <span>${u.email} ${u.is_banned ? 'ðŸ”´' : 'ðŸŸ¢'}<br><b>RM ${u.balance.toFixed(2)}</b></span>
                    <div>
                        <button onclick="editBal('${u.id}',${u.balance})" class="btn-status" style="background:#3b82f6; color:white">EDIT</button>
                        <button onclick="toggleBan('${u.id}', ${u.is_banned})" class="btn-status" style="background:${u.is_banned ? '#10b981' : '#ef4444'}; color:white">
                            ${u.is_banned ? 'UNBAN' : 'BAN'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function approveDep(id, uid, amt) {
            if(!confirm("Luluskan deposit RM" + amt + "?")) return;
            try {
                const { data: userProfile } = await client.from('profiles').select('balance, invited_by').eq('id', uid).single();
                
                // 1. Update Baki & Log User
                await client.from('profiles').update({ balance: (userProfile.balance || 0) + parseFloat(amt) }).eq('id', uid);
                await client.from('transactions').insert([{ user_id: uid, amount: amt, type: 'deposit', description: 'Deposit disahkan' }]);

                // 2. Bonus Referral (10%)
                if (userProfile.invited_by) {
                    const bonus = amt * 0.10;
                    const { data: upline } = await client.from('profiles').select('balance').eq('id', userProfile.invited_by).single();
                    if (upline) {
                        await client.from('profiles').update({ balance: upline.balance + bonus }).eq('id', userProfile.invited_by);
                        await client.from('transactions').insert([{ user_id: userProfile.invited_by, amount: bonus, type: 'bonus', description: 'Bonus referral deposit downline' }]);
                    }
                }
                await client.from('recharges').update({ status: 'success' }).eq('id', id);
                renderAllData();
            } catch (e) { alert(e.message); }
        }

        async function approveWit(id, uid, amt) {
            if(!confirm("Tanda sebagai sudah dibayar?")) return;
            await client.from('withdrawals').update({ status: 'success' }).eq('id', id);
            await client.from('transactions').insert([{ user_id: uid, amount: amt, type: 'withdraw', description: 'Pengeluaran berjaya' }]);
            renderAllData();
        }

        async function toggleBan(uid, currentStatus) {
            if(confirm("Tukar status sekatan user?")) {
                await client.from('profiles').update({ is_banned: !currentStatus }).eq('id', uid);
                renderAllData();
            }
        }

        async function editBal(id, old) {
            const n = prompt("Baki baru:", old);
            if(n !== null) {
                await client.from('profiles').update({ balance: parseFloat(n) }).eq('id', id);
                renderAllData();
            }
        }

        document.addEventListener('DOMContentLoaded', checkAdminAccess);
    </script>
</body>
</html>
