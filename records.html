<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekod Transaksi - MicroVest</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .tab-btn { flex: 1; padding: 12px; border: none; background: white; color: #94a3b8; font-weight: bold; font-size: 13px; cursor: pointer; border-bottom: 2px solid #f1f5f9; transition: 0.3s; }
        .tab-btn.active { color: #800000; border-bottom: 2px solid #800000; background: #fff5f5; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .status-badge.pending { background: #fffbeb; color: #d97706; }
        .status-badge.success, .status-badge.approved { background: #f0fdf4; color: #15803d; }
        .status-badge.failed, .status-badge.rejected { background: #fef2f2; color: #b91c1c; }
        .type-icon { width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; }
    </style>
</head>
<body style="background: #f8fafc;">

    <div class="app-shell">
        <div class="product-page-header" style="background: #800000; color: white; padding: 25px 20px; text-align: center;">
            <h2 style="margin: 0; font-size: 18px;">Penyata Kewangan</h2>
            <p style="margin: 5px 0 0; font-size: 12px; opacity: 0.8;">Semua rekod masuk dan keluar baki anda</p>
        </div>

        <div style="display: flex; background: white; sticky: top; z-index: 10;">
            <button onclick="showTab('all')" id="tab-all" class="tab-btn active">Semua</button>
            <button onclick="showTab('deposit')" id="tab-dep" class="tab-btn">Deposit</button>
            <button onclick="showTab('withdraw')" id="tab-wit" class="tab-btn">Withdraw</button>
        </div>

        <div class="content-area" style="padding: 15px; padding-bottom: 100px;">
            <div id="recordList">
                <p style="text-align: center; color: #94a3b8; padding-top: 50px;">Memuatkan rekod...</p>
            </div>
        </div>

        <nav class="bottom-nav">
            <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
            <a href="product_list.html" class="nav-item"><i class="fas fa-chart-line"></i><span>Produk</span></a>
            <a href="records.html" class="nav-item active"><i class="fas fa-history"></i><span>Rekod</span></a>
            <a href="profile.html" class="nav-item"><i class="fas fa-user-circle"></i><span>Profil</span></a>
        </nav>
    </div>

    <script src="app.js"></script>
    <script>
        async function loadRecords(tabType) {
            const { data: { user } } = await client.auth.getUser();
            if (!user) return;

            const container = document.getElementById('recordList');
            container.innerHTML = '<div style="text-align:center; padding-top:50px;"><i class="fas fa-spinner fa-spin"></i> Memproses...</div>';

            try {
                let data, error;

                if (tabType === 'all') {
                    // Ambil dari Master Table: transactions
                    ({ data, error } = await client
                        .from('transactions')
                        .select('*')
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false }));
                } else {
                    // Ambil dari table spesifik untuk status
                    const table = (tabType === 'deposit') ? 'recharges' : 'withdrawals';
                    ({ data, error } = await client
                        .from(table)
                        .select('*')
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false }));
                }

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = `<div style="text-align:center; margin-top:50px; color:#94a3b8;"><i class="fas fa-folder-open" style="font-size:40px; display:block; margin-bottom:10px;"></i>Tiada rekod ${tabType} ditemui.</div>`;
                    return;
                }

                container.innerHTML = data.map(item => {
                    const date = new Date(item.created_at).toLocaleString('ms-MY', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
                    
                    // Logic untuk tab 'ALL' (Tiada status badge, cuma jenis transaksi)
                    if (tabType === 'all') {
                        let iconClass = "fa-arrow-down";
                        let iconBg = "#dcfce7";
                        let iconColor = "#15803d";
                        let sign = "+";

                        if(item.type === 'withdraw' || item.type === 'investment') {
                            iconClass = item.type === 'withdraw' ? "fa-arrow-up" : "fa-shopping-cart";
                            iconBg = "#fef2f2";
                            iconColor = "#b91c1c";
                            sign = "-";
                        } else if(item.type === 'profit' || item.type === 'bonus') {
                            iconClass = "fa-gift";
                            iconBg = "#fef3c7";
                            iconColor = "#d97706";
                        }

                        return `
                            <div class="recharge-card" style="background:white; margin-bottom:12px; padding:15px; border-radius:15px; display:flex; align-items:center; box-shadow:0 2px 6px rgba(0,0,0,0.02);">
                                <div class="type-icon" style="background:${iconBg}; color:${iconColor};">
                                    <i class="fas ${iconClass}"></i>
                                </div>
                                <div style="flex:1;">
                                    <h4 style="margin:0; font-size:14px; color:#1e293b;">${item.description}</h4>
                                    <small style="color:#94a3b8; font-size:11px;">${date}</small>
                                </div>
                                <div style="text-align:right;">
                                    <b style="color:${sign === '+' ? '#15803d' : '#b91c1c'}; font-size:14px;">${sign} RM ${parseFloat(item.amount).toFixed(2)}</b>
                                </div>
                            </div>
                        `;
                    } 
                    
                    // Logic untuk tab Deposit/Withdraw (Ada status badge)
                    return `
                        <div class="recharge-card" style="background:white; margin-bottom:12px; padding:15px; border-radius:15px; box-shadow:0 2px 6px rgba(0,0,0,0.02);">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <div>
                                    <small style="color:#94a3b8; font-size:11px;">${date}</small>
                                    <h4 style="margin:5px 0; font-size:16px; color:#1e293b;">RM ${parseFloat(item.amount).toFixed(2)}</h4>
                                </div>
                                <span class="status-badge ${item.status}">${item.status}</span>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                container.innerHTML = `<p style="color:red; text-align:center;">Ralat: ${err.message}</p>`;
            }
        }

        function showTab(type) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + (type === 'all' ? 'all' : type === 'deposit' ? 'dep' : 'wit')).classList.add('active');
            loadRecords(type);
        }

        document.addEventListener('DOMContentLoaded', () => loadRecords('all'));
    </script>
</body>
</html>
