<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasukan Saya - MicroVest</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #0056b3; --success: #10b981; --dark: #1e293b; }
        body { background: #f8fafc; font-family: 'Inter', sans-serif; margin: 0; padding: 0; color: var(--dark); }
        
        .header-blue { background: var(--primary); color: white; padding: 30px 20px; text-align: center; border-radius: 0 0 25px 25px; }
        
        .ref-card { background: white; margin: -20px 15px 15px 15px; padding: 20px; border-radius: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .ref-input-group { display: flex; background: #f1f5f9; padding: 8px; border-radius: 12px; margin-top: 10px; border: 1px dashed #cbd5e1; }
        .ref-input-group input { flex: 1; border: none; background: none; font-size: 11px; padding: 5px; outline: none; color: #475569; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 15px; }
        .stat-box { background: white; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #e2e8f0; }
        .stat-box small { font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-box div { font-size: 18px; font-weight: bold; margin-top: 5px; }

        .section-title { padding: 20px 20px 10px 20px; font-size: 14px; font-weight: bold; color: #475569; display: flex; justify-content: space-between; }
        
        .list-wrapper { padding: 0 15px 100px 15px; }
        .data-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        
        .btn-copy { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 11px; font-weight: bold; cursor: pointer; }
        .btn-copy:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <div class="header-blue">
        <h2 style="margin:0; font-size: 20px;">Rangkaian Pasukan</h2>
        <p style="margin:5px 0 0; font-size: 12px; opacity: 0.9;">Bina empayar dan jana komisen 10%</p>
    </div>

    <div class="ref-card">
        <p style="margin:0; font-size: 12px; font-weight: bold; color: #64748b;">Pautan Jemputan Anda</p>
        <div class="ref-input-group">
            <input type="text" id="refUrl" readonly value="Memuatkan pautan...">
            <button class="btn-copy" onclick="copyRef()">SALIN</button>
        </div>
    </div>

    <div class="stat-grid">
        <div class="stat-box">
            <small>Ahli Pasukan</small>
            <div id="totalDownline" style="color: var(--primary);">0</div>
        </div>
        <div class="stat-box">
            <small>Total Komisen</small>
            <div id="totalComm" style="color: var(--success);">RM 0.00</div>
        </div>
    </div>

    <div class="section-title">
        <span>Senarai Ahli (Level 1)</span>
        <i class="fas fa-users-cog"></i>
    </div>
    <div id="memberList" class="list-wrapper" style="padding-bottom: 20px;">
        <center style="padding: 20px; color: #94a3b8; font-size: 12px;">Mencari ahli pasukan...</center>
    </div>

    <div class="section-title">
        <span>Sejarah Komisen</span>
        <i class="fas fa-history"></i>
    </div>
    <div id="commissionList" class="list-wrapper">
        <center style="padding: 20px; color: #94a3b8; font-size: 12px;">Tiada rekod komisen.</center>
    </div>

    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="product_list.html" class="nav-item"><i class="fas fa-box"></i><span>Produk</span></a>
        <a href="team.html" class="nav-item active"><i class="fas fa-users"></i><span>Pasukan</span></a>
        <a href="profile.html" class="nav-item"><i class="fas fa-user"></i><span>Profil</span></a>
    </nav>

    <script src="app.js"></script>
    <script>
        async function initTeam() {
            const { data: { user } } = await client.auth.getUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // 1. Set Pautan Referral
            const link = window.location.origin + "/register.html?ref=" + user.id;
            document.getElementById('refUrl').value = link;

            // 2. Muat Data Ahli (Downline)
            loadDownline(user.id);

            // 3. Muat Sejarah Komisen
            loadCommission(user.id);
        }

        async function loadDownline(uid) {
            const { data, error } = await client
                .from('profiles')
                .select('email, created_at')
                .eq('referred_by', uid);

            const container = document.getElementById('memberList');
            if (data && data.length > 0) {
                document.getElementById('totalDownline').innerText = data.length;
                container.innerHTML = '';
                data.forEach(m => {
                    const date = new Date(m.created_at).toLocaleDateString();
                    container.innerHTML += `
                        <div class="data-card">
                            <div>
                                <div style="font-weight:bold; font-size:13px;">${m.email.split('@')[0]}***</div>
                                <div style="font-size:10px; color:#94a3b8;">Sertai: ${date}</div>
                            </div>
                            <span style="font-size:10px; color:var(--success); font-weight:bold; background:#ecfdf5; padding:4px 8px; border-radius:5px;">AKTIF</span>
                        </div>`;
                });
            } else {
                container.innerHTML = `<center style="padding:20px; color:#94a3b8; font-size:12px;">Belum ada ahli pasukan.</center>`;
            }
        }

        async function loadCommission(uid) {
            const { data, error } = await client
                .from('commission_history')
                .select('*')
                .eq('referrer_id', uid)
                .order('created_at', { ascending: false });

            const container = document.getElementById('commissionList');
            if (data && data.length > 0) {
                let totalVal = 0;
                container.innerHTML = '';
                data.forEach(c => {
                    totalVal += c.commission_amount;
                    const date = new Date(c.created_at).toLocaleDateString();
                    container.innerHTML += `
                        <div class="data-card" style="border-left: 4px solid var(--success);">
                            <div>
                                <div style="font-weight:bold; font-size:12px;">Bonus dari ${c.downline_email.split('@')[0]}***</div>
                                <div style="font-size:10px; color:#94a3b8;">${date}</div>
                            </div>
                            <div style="font-weight:800; color:var(--success); font-size:14px;">+ RM ${c.commission_amount.toFixed(2)}</div>
                        </div>`;
                });
                document.getElementById('totalComm').innerText = `RM ${totalVal.toFixed(2)}`;
            }
        }

        function copyRef() {
            const input = document.getElementById('refUrl');
            input.select();
            input.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(input.value);
            alert("Pautan jemputan disalin!");
        }

        window.onload = initTeam;
    </script>
</body>
</html>
