<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mining Saya - MicroVest</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="background: #f8fafc;">

    <div class="app-shell">
        <div class="product-page-header">
            <h2>Mining Saya</h2>
            <p>Mesin pelaburan sedang bekerja</p>
        </div>

        <div class="content-area" style="padding: 20px; padding-bottom: 100px;">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <div class="recharge-card" style="flex: 1; text-align: center; padding: 15px;">
                    <small style="color: #64748b;">TOTAL MESIN</small>
                    <h2 id="totalMachines" style="color: #1e293b;">0</h2>
                </div>
                <div class="recharge-card" style="flex: 1; text-align: center; padding: 15px;">
                    <small style="color: #64748b;">EST. PROFIT</small>
                    <h2 id="totalProfit" style="color: #10b981;">RM 0.00</h2>
                </div>
            </div>

            <div id="miningList">
                <div style="text-align: center; padding: 40px 0;">
                    <i class="fas fa-box-open" style="font-size: 50px; color: #cbd5e1; margin-bottom: 15px;"></i>
                    <p style="color: #94a3b8;">Tiada mesin aktif. Sila beli pakej di menu Produk.</p>
                </div>
            </div>
        </div>

        <nav class="bottom-nav">
            <a href="dashboard.html" class="nav-item">
                <i class="fas fa-home"></i><span>Home</span>
            </a>
            <a href="product_list.html" class="nav-item">
                <i class="fas fa-chart-line"></i><span>Produk</span>
            </a>
            <a href="mining.html" class="nav-item active">
                <i class="fas fa-microchip"></i><span>Mining</span>
            </a>
            <a href="profile.html" class="nav-item">
                <i class="fas fa-user-circle"></i><span>Profil</span>
            </a>
        </nav>
    </div>

    <script src="app.js"></script>
    <script>
        async function loadActiveMining() {
    const { data: { user } } = await client.auth.getUser();
    if (!user) return;

    try {
        const { data: investments, error } = await client
            .from('investments')
            .select('*')
            .eq('user_id', user.id)
            .eq('status', 'active');

        if (error) throw error;

        const container = document.getElementById('miningList');
        let totalDaily = 0;

        if (investments && investments.length > 0) {
            document.getElementById('totalMachines').innerText = investments.length;
            
            container.innerHTML = investments.map(item => {
                totalDaily += parseFloat(item.daily_profit);
                return `
                    <div class="recharge-card" style="margin-bottom: 15px; border-left: 5px solid #10b981; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0;">${item.product_name}</h4>
                                <small style="color: #64748b;">Mula: ${new Date(item.created_at).toLocaleDateString()}</small>
                            </div>
                            <div style="text-align: right;">
                                <b style="color: #10b981;">+ RM ${parseFloat(item.daily_profit).toFixed(2)}</b><br>
                                <button onclick="claimProfit('${item.id}', ${item.daily_profit})" 
                                        style="margin-top:5px; background:#1e293b; color:white; border:none; padding:4px 8px; border-radius:4px; font-size:10px; cursor:pointer;">
                                    CLAIM PROFIT
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('totalProfit').innerText = `RM ${totalDaily.toFixed(2)}`;
        }
    } catch (err) {
        console.error(err.message);
    }
}

// FUNGSI UNTUK CLAIM DUIT
async function claimProfit(investmentId, amount) {
    const { data: { user } } = await client.auth.getUser();
    
    try {
        // 1. Ambil baki semasa
        const { data: profile } = await client.from('profiles').select('balance').eq('id', user.id).single();
        
        // 2. Tambah baki baru
        const newBalance = parseFloat(profile.balance) + parseFloat(amount);
        
        const { error: updateError } = await client
            .from('profiles')
            .update({ balance: newBalance })
            .eq('id', user.id);

        if (updateError) throw updateError;

        alert(`Berjaya claim RM ${amount.toFixed(2)}! Baki anda telah dikemaskini.`);
        location.reload(); // Refresh untuk nampak baki baru

    } catch (err) {
        alert("Gagal claim: " + err.message);
    }
}

document.addEventListener('DOMContentLoaded', loadActiveMining);

    </script>
</body>
</html>