<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mining Saya - MicroVest</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="background: #f8fafc;">

    <div class="app-shell">
        <div class="product-page-header">
            <h2>Mining Saya</h2>
            <p>Mesin pelaburan sedang bekerja</p>
        </div>

        <div class="content-area" style="padding: 20px; padding-bottom: 100px;">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <div class="recharge-card" style="flex: 1; text-align: center; padding: 15px;">
                    <small style="color: #64748b;">TOTAL MESIN</small>
                    <h2 id="totalMachines" style="color: #1e293b;">0</h2>
                </div>
                <div class="recharge-card" style="flex: 1; text-align: center; padding: 15px;">
                    <small style="color: #64748b;">EST. PROFIT</small>
                    <h2 id="totalProfit" style="color: #10b981;">RM 0.00</h2>
                </div>
            </div>

            <div id="miningList">
                <div style="text-align: center; padding: 40px 0;">
                    <i class="fas fa-box-open" style="font-size: 50px; color: #cbd5e1; margin-bottom: 15px;"></i>
                    <p style="color: #94a3b8;">Tiada mesin aktif. Sila beli pakej di menu Produk.</p>
                </div>
            </div>
        </div>

        <nav class="bottom-nav">
            <a href="dashboard.html" class="nav-item">
                <i class="fas fa-home"></i><span>Home</span>
            </a>
            <a href="product_list.html" class="nav-item">
                <i class="fas fa-chart-line"></i><span>Produk</span>
            </a>
            <a href="mining.html" class="nav-item active">
                <i class="fas fa-microchip"></i><span>Mining</span>
            </a>
            <a href="profile.html" class="nav-item">
                <i class="fas fa-user-circle"></i><span>Profil</span>
            </a>
        </nav>
    </div>

    <script src="app.js"></script>
    <script>
        async function loadActiveMining() {
            const { data: { user } } = await client.auth.getUser();
            if (!user) return;

            try {
                // Ambil data dari table investments
                const { data: investments, error } = await client
                    .from('investments')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('status', 'active');

                if (error) throw error;

                const container = document.getElementById('miningList');
                let totalDaily = 0;

                if (investments.length > 0) {
                    document.getElementById('totalMachines').innerText = investments.length;
                    
                    container.innerHTML = investments.map(item => {
                        totalDaily += parseFloat(item.daily_profit);
                        return `
                            <div class="recharge-card" style="margin-bottom: 15px; border-left: 5px solid #10b981;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="margin: 0;">${item.product_name}</h4>
                                        <small style="color: #64748b;">Mula: ${new Date(item.created_at).toLocaleDateString()}</small>
                                    </div>
                                    <div style="text-align: right;">
                                        <b style="color: #10b981;">+ RM ${parseFloat(item.daily_profit).toFixed(2)}</b><br>
                                        <small style="color: #94a3b8;">Harian</small>
                                    </div>
                                </div>
                                <div style="margin-top: 15px; background: #f1f5f9; height: 8px; border-radius: 10px; overflow: hidden;">
                                    <div class="mining-progress-bar" style="width: 45%; height: 100%; background: #10b981;"></div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    document.getElementById('totalProfit').innerText = `RM ${totalDaily.toFixed(2)}`;
                }
            } catch (err) {
                console.error("Ralat memuatkan mining:", err.message);
            }
        }

        document.addEventListener('DOMContentLoaded', loadActiveMining);
    </script>
</body>
</html>
